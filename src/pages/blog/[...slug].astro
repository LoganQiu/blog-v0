---
import { getCollection, render } from "astro:content";
import SingleLayout from "@/layouts/SingleLayout.astro";
import Meta from "@/components/Meta.astro";
import TOC from "@/components/TOC.astro";
import BackToTop from "@/components/BackToTop.astro";
import { getPostPath, getSlugFromPath } from "@/utils/getPostPath";

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  const sortedPosts = blogEntries
    .filter((entry) => entry.data.draft !== true)
    .sort((a, b) => {
      const dateA = a.data.moddate || a.data.pubdate;
      const dateB = b.data.moddate || b.data.pubdate;
      return dateB.valueOf() - dateA.valueOf();
    });

  return sortedPosts.map((entry, index) => {
    const postPath = getPostPath(entry);
    const slugParam = getSlugFromPath(postPath);

    const prevPost =
      index > 0
        ? {
            url: getPostPath(sortedPosts[index - 1]),
            title: sortedPosts[index - 1].data.title,
          }
        : null;

    const nextPost =
      index < sortedPosts.length - 1
        ? {
            url: getPostPath(sortedPosts[index + 1]),
            title: sortedPosts[index + 1].data.title,
          }
        : null;

    return {
      params: { slug: slugParam },
      props: { entry, prevPost, nextPost },
    };
  });
}

const { entry, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(entry);
const ogImageUrl = `/blog/${entry.data.slug}/index.png`;
const status = entry.data.status;
const isPinned = status === "pinned";
const isDeprecated = status === "deprecated";
const badgeBaseClasses = "text-xs font-semibold tracking-wide border px-2 py-0.5 rounded";
const badgeClass = isPinned
  ? `${badgeBaseClasses} text-accent border-accent/40 bg-accent/10`
  : isDeprecated
    ? `${badgeBaseClasses} text-muted border-muted/60 bg-muted/10`
    : `${badgeBaseClasses} text-muted border-muted/40 bg-muted/10`;
---

<SingleLayout
  title={entry.data.title}
  subtitle={entry.data.subtitle}
  description={entry.data.desc || entry.data.subtitle}
  author={entry.data.author}
  pubdate={entry.data.pubdate}
  moddate={entry.data.moddate}
  prevPost={prevPost}
  nextPost={nextPost}
  ogImage={ogImageUrl}
  katex={entry.data.katex}
>
  <article data-pagefind-body>
    <h1 class="flex flex-wrap items-center gap-2" transition:name={`blog-title-${entry.data.slug}`}>
      <span class:list={{ "line-through text-muted": isDeprecated }}>{entry.data.title}</span>
      {status && <span class={badgeClass}>{status}</span>}
      {entry.data.subtitle && <small class="text-muted font-normal italic basis-full">{entry.data.subtitle}</small>}
    </h1>
    <Meta
      transition:name={`blog-meta-${entry.data.slug}`}
      pubdate={entry.data.pubdate}
      moddate={entry.data.moddate}
      categories={entry.data.categories}
      tags={entry.data.tags}
    />
    <TOC headings={headings} />
    <Content />
  </article>
</SingleLayout>

<BackToTop />

<script>
  function addHeadingLinks() {
    const headings = Array.from(document.querySelectorAll("h2, h3, h4"));
    for (const heading of headings) {
      if (!heading.id) continue;

      (heading as HTMLElement).style.cursor = "pointer";
      heading.addEventListener("click", () => {
        const url = new URL(window.location.href);
        url.hash = heading.id;
        window.history.replaceState({}, "", url.href);
        heading.scrollIntoView({ behavior: "smooth" });
      });
    }
  }

  document.addEventListener("DOMContentLoaded", addHeadingLinks);
  document.addEventListener("astro:page-load", addHeadingLinks);
</script>
